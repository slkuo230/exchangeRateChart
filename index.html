<link rel="import" href="../polymer/polymer.html">
<script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
<dom-module id="dom-element">

    <template>
        <div id="chart"></div>
    </template>

    <script>
        var constants = {
                daysback: 50
        };

        var getTMinusDates =  function (num) {
            var result = [], today = new Date(), date;
            for(var i=num; i>=0; i--) {
                date = new Date();
                date.setDate(today.getDate() - i);
                result.push([date.getFullYear(),('0' + date.getMonth()).slice(-2),('0' + date.getDate()).slice(-2)].join('-'));
            }
            return result;
        };

        var plotChart = function (dateRates) {
            var d = [];
            var r = [];
            dateRates.forEach(function(dr){
                d.push(dr.date);
                r.push(dr.rate);
            });

            var chart = c3.generate({
                data: {
                    x: 'x',
                    columns: [
                        ['x'].concat(d),
                        ['data1'].concat(r)
                    ],
                    types:{
                        data1: 'spline'
                    }
                },
                size: {
                    height: 200//,
                    // width: 480
                },
                axis: {
                    x: {
                        type: 'timeseries',
                        tick: '%m-%d'
                    }
                },
                legend: {
                    show: false
                }
            });
        };

        Polymer({
            is: "dom-element",
            ready: function() {

                var dates = getTMinusDates(30);
                var dateRates = [];
                var finishedCount = 0;

                dates.forEach(function(date){
                    var fixerAPI = "http://api.fixer.io/"+date+"?";
                    $.getJSON( fixerAPI, {
                      symbols: "EUR,USD"
                    })
                    .done(function( data ) {
                        dateRates.push({date: data.date, rate: data.rates.USD});
                        finishedCount++;

                        // final done
                        if (finishedCount == dates.length) {
                            dateRates.sort(function(a, b){
                                return a.date - b.date;
                            });
                            plotChart(dateRates);
                        }
                    });
                });
            }
        });
    </script>

</dom-module>